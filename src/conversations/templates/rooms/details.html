{% extends 'base.html' %}

{% load static %}

{% block content %}
<div class="ui container my-3">
    <div class="ui grid">

        <div class="row">
            <div class="sixteen wide column">
                <h1>{{room.name}}</h1>

                <div id='messages'>
                    {% for msg in cmessages %}
                        <div class="ui message">
                            {{ msg.message }} via {{ msg.sender.user.name }}
                        </div>
                    {% endfor %}
                </div>
                <div class="ui divider"></div>
            </div>
        </div>

        <div class="row">
            <div class="one wide column">
                <div class="ui vertical small basic icon buttons">
                    <button class="ui button"><i class="paperclip icon"></i></button>
                    <button class="ui button"><i class="images icon"></i></button>
                </div>
            </div>
            <div class="fifteen wide column">
                <form id="msg-form" class="ui large container form" method="POST">
                    {% csrf_token %}
                    <div class="field">
                        <label for="msg">Message</label>
                        <textarea name="msg" id="msg" rows="3"></textarea>
                    </div>
                    <button type="submit" class="ui button primary fluid">Send</button>
                </form>
            </div>
        </div>

    </div>
</div>
{% endblock content %}

{% block javascript %}
<script src="{% static 'lib/websocket/reconnecting-websocket.min.js' %}"></script>
<script src="{% static 'js/rooms.js' %}"></script>


<script>
var loc = window.location;
var ws = 'ws://';
if (loc.protocol === 'https:') {
    ws = 'wss://';
}

var endpoint = ws + loc.host + loc.pathname;
//var socket = new ReconnectingWebSocket(endpoint);
var socket = new WebSocket(endpoint);

var formData = $("#msg-form");
var msgInput = $("#msg");
var messages = $('#messages');

socket.onopen = function(e) {
    console.log("open", e);

    // send form data
    formData.submit(function(evt) {
        evt.preventDefault();
        var msgText = msgInput.val();
        var data = {
            'message': msgText
        }
        socket.send(JSON.stringify(data));
        formData[0].reset();
    });
}

socket.onmessage = function(e) {
    console.log("message", e);

    // receive data from the server
    var json = JSON.parse(e.data);

    messages.append("<div class='ui message'>" + json.message + " via " + json.username + "</div>");
}

socket.onclose = function(e) {
    console.log("close", e);
}

socket.onerror = function(e) {
    console.log("error", e);
}

</script>
{% endblock javascript %}